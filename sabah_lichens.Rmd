---
title: 'How much taxonomic expertise is necessary for prioritising areas of lowland rainforest sites as habitats for lichens in northeast Borneo?'
author: 'Rob Mrowicki'
date: '`r format(Sys.time(), "%d %B %Y")`'
output:
  pdf_document:
    fig_caption: yes
    fig_crop: yes
  word_document:
    fig_caption: yes
---

```{r init, include = FALSE}
source('./scripts/00_init.R')  # run initialisation script
```

```{r source_scripts, include = FALSE}
# run data scripts:
source('./scripts/01_import_tidy_and_manipulate_data.R')
source('./scripts/02_summarise_data.R')
source('./scripts/03_analyse_data.R')
source('./scripts/04_plotting.R')
```

## Field sites

Sampling was conducted at three sites within different areas of lowland forest in northeast Borneo, including two old growth reserve sites, (1) Danum Valley Conservation Area ('D') and (2) Maliau Conservation Area ('M'), and one selectively logged site, (3) the Stability of Altered Forest Ecosystems (SAFE) Project area ('S').

At each site, ... (D and M = 96; S = 72).

The following functional traits were recorded for each tree: (1) girth, measured as ...; (2) bark type (DR = dry ancient, S = smooth, C = scaly, R = ridged/rough); and (3) the presence of buttresses or flutes.

```{r nobs_tables, eval = FALSE, echo = FALSE}
# check actual numbers of replicates per site
# tables for numbers of observations vs. site:
# ~ lichen taxonomic groups:
kable(nobs_site_li_taxa, caption = 'Lichen taxonomic group data')
# ~ lichen functional groups:
kable(nobs_site_li_func, caption = 'Lichen functional group data')
# ~ tree functional traits:
kable(nobs_site_tr_func, caption = 'Tree functional trait data')
```


## Data analysis

Lichen taxonomic and functional group richness (_S_) and Shannon-Wiener diversity (_H\'_) were calculated for each tree.

<!-- Tree bark type was coded numerically in relation to increasing perceived water holding capacity, i.e. ancient dry = 1, smooth = 2, scaly = 3, ridged/rough = 4. (See _Queries_ below.) -->

Tree girth was converted into a categorical variable (s < 100 cm; m = 100--199 cm; l $\geq$ 200 cm)


### Differences in lichen diversity among sites

Permutational analysis of variance (PERANOVA) was used to test for differences in lichen taxonomic and functional group richness and diversity among the three sites. Differences in multivariate lichen community structure among sites were tested using permutational multivariate analysis of variance (PERMANOVA), separately for taxonomic and functional groups. Models included the factor 'site' (fixed, 3 levels: D, M and S), with a planned comparison (D, M) vs. S (i.e. undisturbed sites vs. disturbed site). 'Plot' (nested within site) was also included a random factor to account for potential non-independence of trees located within the same plot. Where a significant effect of 'site' was identified, pairwise permutational post-hoc tests were used to reveal differences between individual factor levels. Analyses involved 9,999 permutations of residuals under a reduced model, and tests were based on Type II Sums of Squares owing to unequal numbers of observations among groups.

(Normally, non-metric multidimensional scaling (MDS) plots, which are unconstrained by environmental variables, would be used to visualise overall patterns in lichen community structure... however, MDS analyses failed to converge on a result.)

Relative contributions of individual lichen taxa or functional groups to differences in community structure between groups of sites were determined via similarity of percentages (SIMPER; Clarke, 1993, _Aus. J. Ecol._ 18:117--143).


### Relationships between lichen community structure and tree functional traits

<!-- Pairwise Spearman rank correlations were used to assess the extent of collinearity among tree functional traits (= 'environmental' variables). There were no strong correlations between tree girth, bark type and presence of buttresses/flutes ($|\rho| \leq\ 0.50$), therefore all three variables were included in subsequent analyses. -->

<!-- The biota--environment (BIOENV; Clarke & Ainsworth, 1993, _Mar. Ecol. Prog. Ser._ 92:205--219) routine was used to identify the optimal subset of environmental variables accounting for variability in lichen community structure, via maximisation of the rank correlation between environmental and biological distance matrices. -->

<!-- The variables identified by the BIOENV analysis were then used in a ... -->

The three tree functional traits (= 'environmental' variables) were used in a canonical analysis of principal coordinates (CAP; Anderson & Willis, 2003, _Ecology_ 84:511--525) to enable dissimilarities in lichen communities to be visualised in relation to tree traits. The resulting ordination plot incorporated vectors representing Spearman rank correlations between environmental variables (expressed as continuous/ordinal numerical) and the first two CAP axes. The significance of the overall model (based on the sum of all eigenvalues) and of constraining variables (marginal terms) were assessed via ANOVA-like permutation tests involving `r format(n_perm, big.mark = ",")` permutations. Spearman rank correlation coefficients between individual taxonomic or functional group abundances and CAP axes were calculated to identify the most important groups (i.e. $|\rho| \geq 0.35$) contributing to variability in lichen assemblage structure.

(I'm not sure if it is possible to account for the effects of plot or site, e.g. plot nested within site, when determining the significance of the CAP model, to be consistent with the PERANOVAs and PERMANOVAs.)

For all multivariate tests, community dissimilarities were calculated using the zero-adjusted Bray-Curtis coefficient (Clarke _et al._, 2006, _J. Exp. Mar. Biol. Ecol._ 330:55--80), based on $log10(x+1)$-transformed abundance data to reduce the influence of numerically dominant taxonomic/functional groups. Euclidean distances were calculated from environmental data, which were _z_-standardised to account for scaling differences between variables.

(Check whether exclusion of rare taxonomic/functional groups (e.g. overall mean abundance $\leq$ 0.1) alters results substantially.)


## Preliminary results

Mean lichen diversity (_H\'_ and _S_) per site:

```{r mean_div_tables, echo = FALSE}
# insert summary tables for mean lichen diversity vs. site:
# ~ taxonomic groups:
mean_div_li_taxa %>%
  mutate_at(2:5, ~ formatC(., digits = 2, format = "f")) %>%
  kable(caption = 'Taxonomic group data')
# ~ functional groups:
mean_div_li_func %>%
  mutate_at(2:5, ~ formatC(., digits = 2, format = "f")) %>%
  kable(caption = 'Functional group data')
```

![Boxplot of lichen taxonomic group richness (_S_) and diversity (_H\'_) versus site (D = Danum Valley Conservation Area, M = Maliau Conservation Area, S = Stability of Altered Forest Ecosystems (SAFE) Project area).](./figs/boxplots_taxa.pdf)

![Boxplot of lichen functional group richness and diversity versus site.](./figs/boxplots_func.pdf)

Lichen richness and diversity (in terms of both taxonomic and functional groups) were lower at the logged site (S) compared to the two old growth sites (D and M), which in turn did not differ from each other. (However, in the case of functional group diversity, pairwise post-hoc tests revealed no significant differences among individual sites (P $\geq$ 0.070).)

PERANOVA results:

```{r peranova_tables, echo = FALSE}
options(knitr.kable.NA = '')  # ensure NAs printed as blanks

# insert PERANOVA tables
# ~ taxonomic groups:
# ~~ richness:
li_taxa_s %>%
  mutate_at(3:5, ~ formatC(., digits = 2, format = "f")) %>%
  mutate_at(c(6, 8), ~ formatC(., digits = 3, format = "f")) %>%
  kable(caption = 'Lichen taxonomic group _S_ vs. site')

li_taxa_s_ph %>%
  mutate_at(2, ~ formatC(., digits = 2, format = "f")) %>%
  mutate_at(c(3, 5), ~ formatC(., digits = 3, format = "f")) %>%
  kable(caption = 'Post-hoc pairwise tests')

# ~~ diversity:
li_taxa_h %>%
  mutate_at(3:5, ~ formatC(., digits = 2, format = "f")) %>%
  mutate_at(c(6, 8), ~ formatC(., digits = 3, format = "f")) %>%
  kable(caption = 'Lichen taxonomic group _H\'_ vs. site')

li_taxa_h_ph %>%
  mutate_at(2, ~ formatC(., digits = 2, format = "f")) %>%
  mutate_at(c(3, 5), ~ formatC(., digits = 3, format = "f")) %>%
  kable(caption = 'Post-hoc pairwise tests')

# ~ functional groups:
# ~~ richness:
li_func_s %>%
  mutate_at(3:5, ~ formatC(., digits = 2, format = "f")) %>%
  mutate_at(c(6, 8), ~ formatC(., digits = 3, format = "f")) %>%
  kable(caption = 'Lichen functional group _S_ vs. site')

li_func_s_ph %>%
  mutate_at(2, ~ formatC(., digits = 2, format = "f")) %>%
  mutate_at(c(3, 5), ~ formatC(., digits = 3, format = "f")) %>%
  kable(caption = 'Post-hoc pairwise tests')

# ~~ diversity:
li_func_h %>%
  mutate_at(3:5, ~ formatC(., digits = 2, format = "f")) %>%
  mutate_at(c(6, 8), ~ formatC(., digits = 3, format = "f")) %>%
  kable(caption = 'Lichen functional group _H\'_ vs. site')

li_func_h_ph %>%
  mutate_at(2, ~ formatC(., digits = 2, format = "f")) %>%
  mutate_at(c(3, 5), ~ formatC(., digits = 3, format = "f")) %>%
  kable(caption = 'Post-hoc pairwise tests')
```

There were significant differences in overall lichen community structure (in terms of both taxonomic and functional groups) between old growth and logged sites, but not between Danum and Maliau Conservation Areas.

PERMANOVA tables and post-hoc pairwise test results:

```{r permanova_tables, echo = FALSE}
options(knitr.kable.NA = '')  # ensure NAs printed as blanks

# insert PERMANOVA tables and post-hoc pairwise test results:
# ~ taxonomic groups:
perm_li_taxa %>%
  mutate_at(3:5, ~ formatC(., digits = 2, format = "f")) %>%
  mutate_at(c(6, 8), ~ formatC(., digits = 3, format = "f")) %>%
  kable(caption = 'Lichen community structure (taxonomic groups) vs. site')

perm_li_taxa_ph %>%
  mutate_at(2, ~ formatC(., digits = 2, format = "f")) %>%
  mutate_at(c(3, 5), ~ formatC(., digits = 3, format = "f")) %>%
  kable(caption = 'Post-hoc pairwise tests')

# ~ functional groups:
perm_li_func %>%
  mutate_at(3:5, ~ formatC(., digits = 2, format = "f")) %>%
  mutate_at(c(6, 8), ~ formatC(., digits = 3, format = "f")) %>%
  kable(caption = 'Lichen community structure (functional groups) vs. site')

perm_li_func_ph %>%
  mutate_at(2, ~ formatC(., digits = 2, format = "f")) %>%
  mutate_at(c(3, 5), ~ formatC(., digits = 3, format = "f")) %>%
  kable(caption = 'Post-hoc pairwise tests')
```

Of the lichen taxonomic/functional groups making the greatest contributions to differences in community structure, [_R-Es_, _ArH_, _R-Py_, _Gr-th_, _Gr-li_ and _PyP_] and [_sqhya_, _crbysp_, _crbys_, _crthe_, _crbya_, _crlir_ and _sqhyp_] exhibited higher mean abundances in old growth sites compared to the logged site, whereas [_PoR_ and _ArC_] and [_crpen_, _crstd_, _crstlf_ and _crapo_] showed the opposite trend.

SIMPER tables:
((D,M), S: overall mean abundance in old growth and logged sites, respectively; Contrib./SD: average species contribution to group dissimilarity divided by standard deviation of contributions; Contrib.%: percent contribution of species to overall between-group dissimilarity. Only the most important species (Contrib. $\geq$ 3%) are shown.)

```{r simper_table, echo = FALSE}
# insert SIMPER tables:
# ~ taxonomic groups:
simp_li_taxa[[1]] %>%
  rownames_to_column("Tax. group") %>%
  mutate_at(c(2:4), ~ formatC(., digits = 2, format = "f")) %>%
  mutate_at(5, ~ formatC(., digits = 1, format = "f")) %>%
  kable(
    caption = 'Lichen taxonomic group contributions to differences in community structure',
    longtable = FALSE
  )

# ~ functional groups:
simp_li_func[[1]] %>%
  rownames_to_column("Func. group") %>%
  mutate_at(c(2:4), ~ formatC(., digits = 2, format = "f")) %>%
  mutate_at(5, ~ formatC(., digits = 1, format = "f")) %>%
  kable(
    caption = 'Lichen functional group contributions to differences in community structure',
    longtable = FALSE
  )
```

<!-- Tree girth and presence of buttresses/flutes were identified by BIOENV as key tree traits influencing lichen community structure, in terms of both taxonomic and functional groups (BIOENV; $\rho$ = `r rep_2dp(bioenv_taxa_rho)` and $\rho$ = `r rep_2dp(bioenv_func_rho)`, respectively). -->

CAP axis 1 correlated positively with tree girth, while axis 2 appeared to be related to presence of buttresses/flutes and bark type; however, only tree girth was significant as a constraining variable (taxonomic groups: pseudo-_F_~2,257~ = `r rep_2dp(cap_taxa_margin_f["girth"])`, P `r rep_p(cap_taxa_margin_p["girth"])`; functional groups: pseudo-_F_~2,257~ = `r rep_2dp(cap_func_margin_f["girth"])`, P `r rep_p(cap_func_margin_p["girth"])`), suggesting that it was more important than buttress/flute presence and bark type in structuring lichen communities.

![(a) CAP ordination plot of lichen community structure (taxonomic groups) according to categorical environmental variables. (b) Spearman rank correlation coefficients between CAP axes and individual taxa for which $|\rho| \geq$ `r cor_spp_x`.](./figs/cap_taxa.pdf)

![(a) CAP ordination plot of lichen community structure (functional groups) according to categorical environmental variables. (b) Spearman rank correlation coefficients between CAP axes and individual functional groups for which $|\rho| \geq$ `r cor_spp_x`.](./figs/cap_func.pdf)

Taxonomic groups [_R-Es_, _R-Py_, _ArH_, _PoR_, _Gr-th_, _Gr-li_ and _CaT_] and functional groups [_sqhya_, _crbysp_, _crbya_, _crpen_, _crthe_, _sqhyp_ and _crlir_] appeared to be associated strongly with smaller tree girth. Groups [_Uicr_] and [_crstd_] showed some association with larger girth.


## Queries

1. In both lichen abundance datasets, there are two _D810_ columns -- perhaps one of these (the first one) should be labelled _D710_, as this tree is not present in either dataset? This is what I've done. (Otherwise, should these be combined into a single column _D810_ in each case?)

1. I'm assuming that 'tree no.' is coded as follows: site-plot-tree (i.e. _D111_ = tree 11 in plot 1 in site Danum). Is this correct?
