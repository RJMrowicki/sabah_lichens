---
title: 'How much taxonomic expertise is necessary for prioritising areas of lowland rainforest sites as habitats for lichens in northeast Borneo?'
author: 'Rob Mrowicki'
date: '`r format(Sys.time(), "%d %B %Y")`'
output:
  pdf_document:
    fig_caption: yes
    fig_crop: yes
  word_document:
    fig_caption: yes
---

```{r init, include = FALSE}
source('./scripts/00_init.R')  # run initialisation script
```

```{r source_scripts, include = FALSE}
# run data scripts:
source('./scripts/01_import_tidy_and_manipulate_data.R')
source('./scripts/02_summarise_data.R')
source('./scripts/03_analyse_data.R')
source('./scripts/04_plotting.R')
```

## Field sites

Sampling was conducted at three sites within different areas of lowland forest in northeast Borneo, including two old growth reserve sites, (1) Danum Valley Conservation Area ('D') and (2) Maliau Conservation Area ('M'), and one selectively logged site, (3) the Stability of Altered Forest Ecosystems (SAFE) Project area ('S').

At each site, ... (D and M = 96; S = 72).

The following functional traits were recorded for each tree: (1) girth, measured as $\dots$; (2) bark type (DR = dry ancient, S = smooth, C = scaly, R = ridged/rough); (3) the presence of buttresses or flutes; and (4) dipterocarp vs. non-dipterocarp species. For most, but not all, trees, pH was determined from the mean of up to three readings, measured by $\dots$.

```{r nobs_tables, eval = FALSE, echo = FALSE}
# check actual numbers of replicates per site
# tables for numbers of observations vs. site:
# ~ lichen taxonomic groups:
kable(nobs_site_li_taxa, caption = 'Lichen taxonomic group data')
# ~ lichen functional groups:
kable(nobs_site_li_func, caption = 'Lichen functional group data')
# ~ tree functional traits:
kable(nobs_site_tr_func, caption = 'Tree functional trait data')
```


## Data analysis

Lichen taxonomic and functional group^[It makes sense to calculate univariate diversity measures for taxonomic groups only, and not functional groups, with 'functional diversity' represented by the four distance-based FD indices.] richness (_S_), Shannon-Wiener diversity (_H\'_) and Simpson's evenness ($1-\lambda$) were calculated for each tree. Additionally, lichen abundance data were summed for each plot, and plot-level richness, diversity and evenness were calculated for both taxonomic and functional groups.^['Tree-level' calculations could be excluded altogether, with analyses focussing solely on 'plot-level' data, given that, for tree-level data, (1) some distance-based FD indices cannot be calculated and (2) MDS fails to converge (see below), and (3) in practical terms, surveys would be conducted at the scale of plots rather than individual trees.]

Further, the following distance-based functional diversity indices were calculated from lichen functional group abundance data in conjunction with the functional traits matrix (Table), using the function `dbFD` in the R package `FD`: functional richness (FRic), functional evenness (FEve), functional divergence (FDiv) and functional dispersion (FDis). While all four indices were calculated for each plot based on summed abundances, only FEve and FDis were calculated for individual trees, owing to instances of <3 singular functional groups per tree.^[Still, it was not possible to calculate FEve and FDis for all individual trees, again owing to a number of instances of <3 singular functional groups.]

<!-- Tree bark type was coded numerically in relation to increasing perceived water holding capacity, i.e. ancient dry = 1, smooth = 2, scaly = 3, ridged/rough = 4. (See _Queries_ below.) -->

Tree girth and mean pH were converted into categorical variables (girth: s < 100 cm; m = 100--199 cm; l $\geq$ 200 cm; pH: vl < 2; l 2 $\leq x <$ 4; m 4--6; h $\geq$ 6).

To enable plot-level characterisation of tree traits as continuous variables, we calculated (1) the Shannon-Wiener diversity of bark type categories, and the proportion of (2) large trees (i.e. girth $\geq$ 200 cm), (3) trees with buttresses or flutes and (4) dipterocarp trees within each plot.


### Differences in lichen diversity among sites

Permutational analysis of variance (PERANOVA)^[probability distributions are not really suitable for GLMMs, hence the use of PERANOVA. Another alternative is to use zero-inflated models.] was used to test for differences in univariate lichen taxonomic and functional group richness, diversity and evenness measures (including distance-based functional diversity indices)^['Tree-level' data appears to be insufficient for calculating FRic and FDiv.] among the three sites. Differences in multivariate lichen community structure among sites were tested using permutational multivariate analysis of variance (PERMANOVA), separately for taxonomic and functional groups. Models included the factor 'site' (fixed, 3 levels: D, M and S), with a planned comparison (D, M) vs. S (i.e. undisturbed sites vs. disturbed site). 'Plot' (nested within site) was also included a random factor to account for potential non-independence of trees located within the same plot. Where a significant effect of 'site' was identified, pairwise permutational post-hoc tests were used to reveal differences between individual factor levels. Analyses involved 9,999 permutations of residuals under a reduced model, and tests were based on Type II Sums of Squares owing to unequal numbers of observations among groups.

To complement these unconstrained multivariate analyses, overall patterns in lichen community structure were visualised using non-metric multidimensional scaling (MDS) ordination plots, based on both taxonomic and functional groups.^[Although the MDS analyses (performed using the `metaMDS` function in the R package `vegan`) failed to 'converge' on a result and produced relatively high 2D stress values, they still serve as a useful representation of overall patterns -- to be interpreted with some caution. On the other hand, MDS converges successfully for summed 'plot-level' abundance data.]

Relative contributions of individual lichen taxa or functional groups to differences in community structure between groups of sites identified by PERMANOVA were determined via similarity of percentages (SIMPER; Clarke, 1993, _Aus. J. Ecol._ 18:117--143).

For all multivariate tests (both unconstrained and constrained), community dissimilarities were calculated using the zero-adjusted Bray-Curtis coefficient (Clarke _et al._, 2006, _J. Exp. Mar. Biol. Ecol._ 330:55--80), based on $log10(x+1)$-transformed abundance data to reduce the influence of numerically dominant taxonomic/functional groups. Euclidean distances were calculated from environmental data, which were _z_-standardised to account for scaling differences between variables.


### Relationships between lichen community structure and tree functional traits ('tree-level' & 'plot-level')

To enable dissimilarities in lichen communities to be visualised in relation to tree functional traits, the four tree traits (= 'environmental' variables) were used in a constrained distance-based redundancy analysis (dbRDA), a variant of canonical analysis of principal coordinates (CAP; Anderson & Willis, 2003, _Ecology_ 84:511--525), using the `capscale` function in the R package `vegan` (version 2.5-6; Oksanen et al., 2019). While traditional CAP may be performed as a discriminant analysis (as opposed to a canonical correlation analysis) involving a single grouping variable, dbRDA allows for the inclusion of multiple categorical constraints.

This analysis, performed separately for lichen taxonomic and functional groups, was conducted at both (1) 'tree-level', whereby individual trees were treated as replicates, with tree traits expressed as categorical variables, and (2) 'plot-level', involving summed lichen abundances and continuous tree trait variables calculated for each plot as described above. To account for variation among plots in the tree-level analysis, 'plot' was included as a conditioning variable in the dbRDA model.

Prior to plot-level analyses, pairwise Spearman rank correlations were used to assess the extent of collinearity among tree traits. There were no strong correlations between bark type diversity and proportions of large trees, trees with buttresses/flutes and dipterocarp trees ($|\rho| \leq\ 0.50$), therefore all four variables were included in subsequent analyses. The biota--environment (BIOENV; Clarke & Ainsworth, 1993, _Mar. Ecol. Prog. Ser._ 92:205--219) routine was used to identify the optimal subset of environmental variables accounting for variability in lichen community structure, via maximisation of the rank correlation between environmental and biological distance matrices. The variables identified by the BIOENV analysis were then used in the dbRDA analysis. The resulting ordination plots for plot-level analyses incorporated vectors representing Spearman rank correlations between continuous environmental variables and the first two CAP axes.

The significance of overall models (based on the sum of all eigenvalues) and of constraining variables (marginal terms) were assessed via ANOVA-like permutation tests involving `r format(n_perm, big.mark = ",")` permutations. Spearman rank correlation coefficients between individual taxonomic or functional group abundances and CAP axes were calculated to identify the most important groups (i.e. $|\rho| \geq$ `r cor_spp_x`) contributing to variability in lichen assemblage structure.


### Classification of sites based on lichen communities ('plot-level')

A 'plot-level' CAP analysis, based on summed lichen abundances, was used to estimate the accuracy with which plots may be assigned to sites based on lichen community structure. This cross-validation method involves the 'leave-one-out' approach of Lachenbruch and Mickey (1968; _Technometrics_ 10:1--11) to determine the proportion of individual observations (in this case, plots) that are successfully allocated to the correct group (Anderson & Willis, 2003). Using the CAP FORTRAN programme (Anderson, 2002, _Ecological Archives_ E084-011-S1), this analysis was performed separately for lichen taxonomic and functional groups, versus a single factor, 'site' (i.e. a discriminant analysis, rather than a canonical correlation analysis).


^[Check whether exclusion of rare taxonomic/functional groups (e.g. overall mean abundance $\leq$ 0.1) alters results substantially.]


## Preliminary results

Mean lichen diversity (taxonomic group _H\'_ and _S_; functional group _H\'_ , _S_, FEve and FDis) per site:

```{r mean_div_tables, echo = FALSE}
# insert summary tables for mean lichen diversity vs. site:
# ~ taxonomic groups:
mean_div_li_taxa %>%
  mutate_at(2:5, ~ formatC(., digits = 2, format = "f")) %>%
  kable(caption = 'Taxonomic group data')
# ~ functional groups:
mean_div_li_func %>%
  mutate_at(2:5, ~ formatC(., digits = 2, format = "f")) %>%
  kable(caption = 'Functional group data')
```

![Boxplot of lichen taxonomic group richness (_S_) and diversity (_H\'_) versus site (D = Danum Valley Conservation Area, M = Maliau Conservation Area, S = Stability of Altered Forest Ecosystems (SAFE) Project area).](./figs/boxplots_taxa.pdf)

![Boxplot of lichen functional group richness and diversity and distance-based functional diversity indices (FEve and FDis) versus site.](./figs/boxplots_func.pdf)

Lichen richness and diversity (in terms of both taxonomic and functional groups) were lower at the logged site (S) compared to the two old growth sites (D and M), which in turn did not differ from each other. (However, in the case of functional group diversity, pairwise post-hoc tests revealed no significant differences among individual sites (P $\geq$ 0.070).)

PERANOVA results:

```{r peranova_tables_taxa_s, echo = FALSE}
options(knitr.kable.NA = '')  # ensure NAs printed as blanks
# insert PERANOVA tables:

# ~ taxonomic groups:
# ~~ richness:
li_taxa_s %>%
  mutate_at(3:5, ~ formatC(., digits = 2, format = "f")) %>%
  mutate_at(c(6, 8), ~ formatC(., digits = 3, format = "f")) %>%
  kable(caption = 'Lichen taxonomic group _S_ vs. site')

li_taxa_s_ph %>%
  mutate_at(2, ~ formatC(., digits = 2, format = "f")) %>%
  mutate_at(c(3, 5), ~ formatC(., digits = 3, format = "f")) %>%
  kable(caption = 'Post-hoc pairwise tests')
```

```{r peranova_tables_taxa_h, echo = FALSE}
options(knitr.kable.NA = '')  # ensure NAs printed as blanks

# ~~ diversity:
li_taxa_h %>%
  mutate_at(3:5, ~ formatC(., digits = 2, format = "f")) %>%
  mutate_at(c(6, 8), ~ formatC(., digits = 3, format = "f")) %>%
  kable(caption = 'Lichen taxonomic group _H\'_ vs. site')

li_taxa_h_ph %>%
  mutate_at(2, ~ formatC(., digits = 2, format = "f")) %>%
  mutate_at(c(3, 5), ~ formatC(., digits = 3, format = "f")) %>%
  kable(caption = 'Post-hoc pairwise tests')
```

```{r peranova_tables_func_s, echo = FALSE}
options(knitr.kable.NA = '')  # ensure NAs printed as blanks

# ~ functional groups:
# ~~ richness:
li_func_s %>%
  mutate_at(3:5, ~ formatC(., digits = 2, format = "f")) %>%
  mutate_at(c(6, 8), ~ formatC(., digits = 3, format = "f")) %>%
  kable(caption = 'Lichen functional group _S_ vs. site')

li_func_s_ph %>%
  mutate_at(2, ~ formatC(., digits = 2, format = "f")) %>%
  mutate_at(c(3, 5), ~ formatC(., digits = 3, format = "f")) %>%
  kable(caption = 'Post-hoc pairwise tests')
```

```{r peranova_tables_func_h, echo = FALSE}
options(knitr.kable.NA = '')  # ensure NAs printed as blanks

# ~~ diversity:
li_func_h %>%
  mutate_at(3:5, ~ formatC(., digits = 2, format = "f")) %>%
  mutate_at(c(6, 8), ~ formatC(., digits = 3, format = "f")) %>%
  kable(caption = 'Lichen functional group _H\'_ vs. site')

li_func_h_ph %>%
  mutate_at(2, ~ formatC(., digits = 2, format = "f")) %>%
  mutate_at(c(3, 5), ~ formatC(., digits = 3, format = "f")) %>%
  kable(caption = 'Post-hoc pairwise tests')
```

There were significant differences in overall lichen community structure (in terms of both taxonomic and functional groups) between old growth and logged sites, but not between Danum and Maliau Conservation Areas. This pattern was evident from MDS plots showing separation between the SAFE Project area and the other two sites, particularly for 'plot-level' data summarised per plot.

PERMANOVA tables and post-hoc pairwise test results:

```{r permanova_tables_taxa, echo = FALSE}
options(knitr.kable.NA = '')  # ensure NAs printed as blanks

# insert PERMANOVA tables and post-hoc pairwise test results:
# ~ taxonomic groups:
perm_li_taxa %>%
  mutate_at(3:5, ~ formatC(., digits = 2, format = "f")) %>%
  mutate_at(c(6, 8), ~ formatC(., digits = 3, format = "f")) %>%
  kable(caption = 'Lichen community structure (taxonomic groups) vs. site')

perm_li_taxa_ph %>%
  mutate_at(2, ~ formatC(., digits = 2, format = "f")) %>%
  mutate_at(c(3, 5), ~ formatC(., digits = 3, format = "f")) %>%
  kable(caption = 'Post-hoc pairwise tests')
```

```{r permanova_tables_func, echo = FALSE}
options(knitr.kable.NA = '')  # ensure NAs printed as blanks

# insert PERMANOVA tables and post-hoc pairwise test results:
# ~ functional groups:
perm_li_func %>%
  mutate_at(3:5, ~ formatC(., digits = 2, format = "f")) %>%
  mutate_at(c(6, 8), ~ formatC(., digits = 3, format = "f")) %>%
  kable(caption = 'Lichen community structure (functional groups) vs. site')

perm_li_func_ph %>%
  mutate_at(2, ~ formatC(., digits = 2, format = "f")) %>%
  mutate_at(c(3, 5), ~ formatC(., digits = 3, format = "f")) %>%
  kable(caption = 'Post-hoc pairwise tests')
```

![Non-metric multidimensional scaling (MDS) plot of lichen community structure as (a) taxonomic and (b) functional groups, using 'tree-level' data (i.e. individual trees as replicates). Based on zero-adjusted Bray-Curtis dissimilarities calculated from $log10(x+1)$-transformed abundance data. Ellipses represent the standard deviation of points within each group.](./figs/mds.pdf)

![Non-metric multidimensional scaling (MDS) plot of lichen community structure as (a) taxonomic and (b) functional groups, using 'plot-level' data summarised for each plot. Based on zero-adjusted Bray-Curtis dissimilarities calculated from $log10(x+1)$-transformed abundance data. Ellipses represent the standard deviation of points within each group.](./figs/mds_plot.pdf)

Of the lichen taxonomic/functional groups making the greatest contributions to differences in community structure, [_R-Es_, _ArH_, _R-Py_, _Gr-th_, _Gr-li_ and _PyP_] and [_crbys_, _sqhya_,  _crthe_, _crbya_, _sqhyp_ and _crpeb_] exhibited higher mean abundances in old growth sites compared to the logged site, whereas [_PoR_ and _ArC_] and [_crtstl_, _crpen_ and _crapo_] showed the opposite trend.

SIMPER tables:
((D,M), S: overall mean abundance in old growth and logged sites, respectively; Contrib./SD: average species contribution to group dissimilarity divided by standard deviation of contributions; Contrib.%: percent contribution of species to overall between-group dissimilarity. Only the most important species (Contrib. $\geq$ 3%) are shown.)

```{r simper_table_taxa, echo = FALSE}
# insert SIMPER table:
# ~ taxonomic groups:
simp_li_taxa[[1]] %>%
  rownames_to_column("Tax. group") %>%
  mutate_at(c(2:4), ~ formatC(., digits = 2, format = "f")) %>%
  mutate_at(5, ~ formatC(., digits = 1, format = "f")) %>%
  kable(
    caption = 'Lichen taxonomic group contributions to differences in community structure',
    longtable = FALSE
  )
```

```{r simper_table_func, echo = FALSE}
# insert SIMPER table:
# ~ functional groups:
simp_li_func[[1]] %>%
  rownames_to_column("Func. group") %>%
  mutate_at(c(2:4), ~ formatC(., digits = 2, format = "f")) %>%
  mutate_at(5, ~ formatC(., digits = 1, format = "f")) %>%
  kable(
    caption = 'Lichen functional group contributions to differences in community structure',
    longtable = FALSE
  )
```

![(a) CAP ordination plot of lichen community structure (taxonomic groups) according to categorical environmental (tree trait) variables, based on 'tree-level' data (i.e. individual trees as replicates). (b) Spearman rank correlation coefficients between CAP axes and individual taxa for which $|\rho| \geq$ `r cor_spp_x`.](./figs/cap_taxa.pdf)

![(a) CAP ordination plot of lichen community structure (functional groups) according to categorical environmental (tree trait) variables, based on 'tree-level' data (i.e. individual trees as replicates). (b) Spearman rank correlation coefficients between CAP axes and individual functional groups for which $|\rho| \geq$ `r cor_spp_x`.](./figs/cap_func.pdf)

![(a) CAP ordination plot of lichen community structure (taxonomic groups) according to continuous environmental (tree trait) variables, based on 'plot-level' data summarised for each plot. (b) Spearman rank correlation coefficients between CAP axes and individual taxa for which $|\rho| \geq$ `r cor_spp_x`.](./figs/cap_taxa_plot.pdf)

![(a) CAP ordination plot of lichen community structure (functional groups) according to continuous environmental (tree trait) variables, based on 'plot-level' data summarised for each plot. (b) Spearman rank correlation coefficients between CAP axes and individual functional groups for which $|\rho| \geq$ `r cor_spp_x`.](./figs/cap_func_plot.pdf)


\newpage

(Something about 'tree-level' dbRDA results here...)

When considering individual trees as replicates, tree girth (expressed as a categorical variable) and classification as dipterocarp vs. non-dipterocarp had a significant effect on the structure of lichen communities, for both taxonomic (girth: F~2,235~ = `r rep_2dp(cap_taxa_margin_f["girth"])`, P `r rep_p(cap_taxa_margin_p["girth"])`; dipterocarp: F~2,235~ = `r rep_2dp(cap_taxa_margin_f["dipterocarp"])`, P `r rep_p(cap_taxa_margin_p["dipterocarp"])`) and functional groups (girth: F~2,235~ = `r rep_2dp(cap_func_margin_f["girth"])`, P `r rep_p(cap_func_margin_p["girth"])`; dipterocarp: F~2,235~ = `r rep_2dp(cap_func_margin_f["dipterocarp"])`, P `r rep_p(cap_func_margin_p["dipterocarp"])`), as revealed by dbRDA permutation tests for marginal effects of terms.

For 'plot-level' analyses, the diversity of bark types and proportion of dipterocarps were identified as key tree traits influencing lichen community structure, in terms of both taxonomic and functional groups (BIOENV; $\rho$ = `r rep_2dp(bioenv_taxa_plot_rho)` and $\rho$ = `r rep_2dp(bioenv_func_plot_rho)`, respectively).

CAP (dbRDA) axis 1 correlated negatively with both plot-level tree traits, while axis 2 appeared to be related positively to bark diversity and negatively to dipterocarp proportion; however, while neither 'trait' was significant as a constraining variable for lichen taxonomic group data, only the proportion of dipterocarps was significantly related to lichen community structure in terms of functional groups (pseudo-_F_~1,19~ = `r rep_2dp(cap_taxa_plot_margin_f["dipterocarp_prop"])`, P `r rep_p(cap_taxa_plot_margin_p["dipterocarp_prop"])`).

Taxonomic groups [_ArA_, _ArT_, _CnS_, _CoC_, _Gr-th_, _PyP_, _R-Py_, _ThM_, _TryP_ and _VeFl_] and functional groups [_crapr_, _crbys_, _crmzs_, _crpeb_, _crspe_, _crthe_, _crtr_, _focyr_ and _sqhya_] appeared to be associated strongly with plot-level bark diversity. Groups [_Gr-Li_, and _R-Es_] and [_crbya_] were also associated with bark diversity, but showed a stronger association with the proportion of dipterocarps. Taxon [_PiM_] in particular appeared to be strongly associated with the proportion of dipterocarps. Conversely, taxa [_ArC_ and _Uicr_ ] were negatively associated with both bark diversity and proportion of dipterocarps.

The overall success with which plots could be classified by site based on summed lichen abundance data (CAP) was `r rep_2dp(succ_cap_taxa_site_plot)`% (15/22 plots) for taxonomic groups and `r rep_2dp(succ_cap_func_site_plot)`% (14/22 plots) for functional groups.

```{r cap_table, echo = FALSE}
# ~ taxonomic groups:

# succ_table %>%
#   kable(caption = '')

```


## Queries

1. In both lichen abundance datasets, there are two _D810_ columns -- perhaps one of these (the first one) should be labelled _D710_, as this tree is not present in either dataset? This is what I've done. (Otherwise, should these be combined into a single column _D810_ in each case?)

1. I'm assuming that 'tree no.' is coded as follows: site-plot-tree (i.e. _D111_ = tree 11 in plot 1 in site Danum). Is this correct?
